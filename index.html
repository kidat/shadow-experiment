<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shadow Color Perception Experiment</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 20px;
      min-height: 100vh;
      color: #fff;
    }
    #jspsych-target {
      width: 100%;
      max-width: 900px;
      text-align: center;
      overflow-x: auto;
      padding: 0 10px;
    }
    img {
      max-height: 450px;
      max-width: 45vw;
      height: auto;
      width: auto;
      object-fit: contain;
      border: 3px solid #fff;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.25);
      transition: transform 0.3s ease;
    }
    img:hover {
      transform: scale(1.02);
    }
    .welcome-card {
      background: rgba(255, 255, 255, 0.92);
      padding: 40px 30px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
      color: #333;
      max-width: 700px;
      margin: 0 auto;
      backdrop-filter: blur(10px);
    }
    .welcome-card h1 {
      font-size: 2.4rem;
      margin-bottom: 20px;
      color: #1a237e;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .welcome-card h2 {
      color: #283593;
      margin-top: 25px;
      margin-bottom: 15px;
    }
    .welcome-card p {
      font-size: 1.15rem;
      line-height: 1.6;
      margin-bottom: 25px;
    }
    .jspsych-btn {
      font-size: 1.15rem !important;
      padding: 14px 35px !important;
      border-radius: 12px !important;
      background: linear-gradient(to right, #2962ff, #0039cb) !important;
      color: white !important;
      border: none !important;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 15px !important;
      box-shadow: 0 4px 8px rgba(41, 98, 255, 0.3);
    }
    .jspsych-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(41, 98, 255, 0.4);
    }
    .jspsych-btn:active {
      transform: translateY(0);
    }
    .error-message {
      color: #d32f2f;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .success-message {
      color: #2e7d32;
      font-weight: bold;
      font-size: 1.1rem;
    }
    .progress-container {
      width: 100%;
      max-width: 700px;
      margin: 30px auto;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      border-radius: 10px;
      transition: width 0.5s cubic-bezier(0.22, 0.61, 0.36, 1);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }
    .phase-indicator {
      font-weight: bold;
      margin: 15px 0;
      font-size: 1.3rem;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
      letter-spacing: 0.5px;
    }
    .trial-counter {
      color: #e3f2fd;
      font-size: 1.1rem;
      margin-bottom: 15px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .form-group {
      margin: 25px 0;
    }
    .form-group input {
      width: 200px;
      padding: 14px 20px;
      font-size: 1.2rem;
      border-radius: 10px;
      border: 2px solid #bbdefb;
      text-align: center;
      transition: all 0.3s;
    }
    .form-group input:focus {
      outline: none;
      border-color: #2962ff;
      box-shadow: 0 0 10px rgba(41, 98, 255, 0.3);
    }
    .image-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 30px 0;
    }
    .question-text {
      font-size: 1.3rem;
      font-weight: 600;
      margin: 25px 0;
      color: #0d47a1;
      text-shadow: 0 1px 1px rgba(255,255,255,0.5);
    }
    .highlight {
      background: linear-gradient(120deg, #e1f5fe, #bbdefb);
      padding: 3px 8px;
      border-radius: 5px;
      font-weight: 600;
    }
    .debrief-section {
      text-align: left;
      background: rgba(255, 255, 255, 0.92);
      padding: 30px;
      border-radius: 15px;
      margin: 30px 0;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .debrief-section h3 {
      color: #1a237e;
      border-bottom: 2px solid #bbdefb;
      padding-bottom: 10px;
      margin-top: 0;
    }
    .debrief-section ul {
      padding-left: 25px;
    }
    .debrief-section li {
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .footer {
      margin-top: 30px;
      color: #e3f2fd;
      font-size: 0.9rem;
    }
    .response-feedback {
      font-size: 1.1rem;
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.85);
      max-width: 500px;
      margin: 20px auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #f00;
      border-radius: 50%;
      opacity: 0.7;
      animation: fall linear forwards;
    }
    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  <div class="progress-container" style="display: none;">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
  <div class="phase-indicator" id="phase-indicator" style="display: none;"></div>
  <div class="trial-counter" id="trial-counter" style="display: none;"></div>

  <script>
    // --- CONFIG ---
    const GITHUB_USERNAME = "kidat";
    const GITHUB_REPO = "shadow-experiment";
    const IMAGES_BRANCH = "main";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYYfej-4FG59R2Bah_LKwnIpTYmLA2DiBdEyIJInMTWM4TGL9ODcXr5eGBOueXsEcNYg/exec";

    const repoBase = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${IMAGES_BRANCH}/`;
    const images = Array.from({ length: 15 }, (_, i) => `${repoBase}images/${i + 1}.png`);

    const jsPsych = initJsPsych({ 
      display_element: 'jspsych-target',
      on_timeline_finish: function() {
        document.querySelector('.progress-container').style.display = 'none';
        document.getElementById('phase-indicator').style.display = 'none';
        document.getElementById('trial-counter').style.display = 'none';
      }
    });

    // Global variables to store save status
    let saveResult = null;
    let participantID = null;

    // Enhanced save function
    async function saveToGoogleSheets(pid, trialsData) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ participantID: pid, trials: trialsData }),
          redirect: "follow",
          mode: "no-cors"
        });
    
        // Treat opaque OR ok===true as a successful save
        if (response.type === 'opaque' || response.ok) {
          return { success: true, message: "Data submitted successfully" };
        } else {
          throw new Error(`Server responded with status ${response.status}`);
        }
      } catch (e) {
        console.error("Save error:", e);
        return { success: false, message: e.message };
      }
    }

    // Function to update progress bar
    function updateProgressBar(currentTrial, totalTrials, phaseName) {
      const progressBar = document.getElementById('progress-bar');
      const phaseIndicator = document.getElementById('phase-indicator');
      const trialCounter = document.getElementById('trial-counter');
      
      // Show elements
      document.querySelector('.progress-container').style.display = 'block';
      phaseIndicator.style.display = 'block';
      trialCounter.style.display = 'block';
      
      // Calculate progress
      const percent = Math.round((currentTrial / totalTrials) * 100);
      progressBar.style.width = `${percent}%`;
      
      // Update text
      phaseIndicator.textContent = `Current Phase: ${phaseName}`;
      trialCounter.textContent = `Trial ${currentTrial} of ${totalTrials} (${percent}%)`;
    }

    // Function to create randomized pairs
    function createRandomizedPairs() {
      const pairs = [];
      
      // Create consecutive pairs
      for (let i = 0; i < images.length; i += 5) {
        const block = images.slice(i, i + 5);
        for (let j = 0; j < block.length - 1; j++) {
          pairs.push([block[j], block[j+1]]);
        }
      }
      
      // Randomize order of pairs
      jsPsych.randomization.shuffle(pairs);
      
      // Randomize left/right position for each pair
      return pairs.map(pair => 
        Math.random() < 0.5 ? pair : [pair[1], pair[0]]
      );
    }

    // Function to create confetti effect
    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
      const container = document.getElementById('jspsych-target');
      
      for (let i = 0; i < 150; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = confetti.style.width;
        confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
        container.appendChild(confetti);
        
        // Remove confetti after animation completes
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    function createTimeline() {
      const timeline = [];
      let trialCounter = 0;
      const totalTrials = Math.floor(images.length / 5) * 4 * 2 + images.length; // Phase1 + Phase2 + Phase3

      // Preload images with loading screen
      timeline.push({
        type: jsPsychPreload,
        images: images,
        message: '<div style="font-size: 1.3rem; margin-bottom: 20px;">Loading experiment assets...</div>',
        show_progress_bar: true,
        continue_after_error: true
      });

      // Welcome screen
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h1>üîÆ Shadow Color Perception Experiment</h1>
            <p>Welcome to our study on visual perception of shadows! This experiment explores how humans perceive differences in shadow brightness and color.</p>
            <p>You'll participate in three phases where you'll compare shadows in various images. The entire experiment takes about 10-15 minutes.</p>
            <p>Your participation will contribute to our understanding of visual perception and help advance research in cognitive psychology.</p>
            <p>Click <strong>"Begin"</strong> when you're ready to start.</p>
          </div>`,
        choices: ['Begin']
      });
      
      // ID collection
      timeline.push({
        type: jsPsychSurveyHtmlForm,
        preamble: `
          <div class="welcome-card">
            <h2>Participant Identification</h2>
            <p>Please enter the 4-digit ID provided to you</p>
          </div>`,
        html: `
          <div class="form-group">
            <input name="participant_id" type="text" pattern="\\d{4}" maxlength="4" required 
                   placeholder="Enter 4-digit ID" autocomplete="off" />
            <p class="response-feedback">This ID ensures your data is recorded correctly and anonymously</p>
          </div>`,
        button_label: 'Continue'
      });

      // Phase 1 Instruction
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h2>Phase 1: Shadow Brightness Differences</h2>
            <p>In this phase, you'll see pairs of images side by side.</p>
            <p><span class="highlight">Your task is to select the image with the brighter shadow</span></p>
            <p>You'll complete ${Math.floor(images.length / 5) * 4} comparisons.</p>
            <p>Please respond as naturally as possible - there are no right or wrong answers.</p>
          </div>`,
        choices: ['Start Phase 1'],
        on_load: function() {
          document.querySelector('.progress-container').style.display = 'none';
          document.getElementById('phase-indicator').style.display = 'none';
          document.getElementById('trial-counter').style.display = 'none';
        }
      });

      // Create randomized pairs for Phase 1 and 2
      const randomizedPairs = createRandomizedPairs();

      // Phase 1 trials
      randomizedPairs.forEach((pair, idx) => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="image-container">
              <img src="${pair[0]}" alt="Left image" />
              <img src="${pair[1]}" alt="Right image" />
            </div>
            <div class="question-text">Which shadow appears brighter?</div>
          `,
          choices: ['Left Shadow', 'Same Brightness', 'Right Shadow'],
          data: {
            phase: 'phase1',
            image_left: pair[0].split('/').pop(),
            image_right: pair[1].split('/').pop(),
            trial_index: idx + 1,
            total_trials: randomizedPairs.length
          },
          on_start: function() {
            trialCounter++;
            updateProgressBar(trialCounter, totalTrials, "Shadow Brightness");
          },
          post_trial_gap: 300,
          on_finish: data => {
            const labels = ['left', 'same', 'right'];
            data.response = labels[data.response];
            data.chosen_image = data.response === 'left'
              ? data.image_left
              : data.response === 'right'
              ? data.image_right
              : 'same';
          }
        });
      });

      // Phase 2 Instruction
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h2>Phase 2: Shadow Color Differences</h2>
            <p>In this phase, you'll again see pairs of images side by side.</p>
            <p><span class="highlight">Your task is to determine if the shadows appear to differ in color</span></p>
            <p>You'll complete ${Math.floor(images.length / 5) * 4} comparisons.</p>
            <p>Focus on the color properties of the shadows (hue, saturation) rather than brightness.</p>
          </div>`,
        choices: ['Start Phase 2'],
        on_load: function() {
          document.querySelector('.progress-container').style.display = 'none';
          document.getElementById('phase-indicator').style.display = 'none';
          document.getElementById('trial-counter').style.display = 'none';
        }
      });

      // Phase 2 trials
      randomizedPairs.forEach((pair, idx) => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="image-container">
              <img src="${pair[0]}" alt="Left image" />
              <img src="${pair[1]}" alt="Right image" />
            </div>
            <div class="question-text">Do you see a color difference between the shadows?</div>
          `,
          choices: ['Yes', 'No'],
          data: {
            phase: 'phase2',
            image_left: pair[0].split('/').pop(),
            image_right: pair[1].split('/').pop(),
            trial_index: idx + 1,
            total_trials: randomizedPairs.length
          },
          on_start: function() {
            trialCounter++;
            updateProgressBar(trialCounter, totalTrials, "Color Difference");
          },
          post_trial_gap: 300,
          on_finish: data => {
            data.response = data.response === 0 ? 'yes' : 'no';
          }
        });
      });

      // Phase 3 Instruction
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h2>Phase 3: Shadow Intensity in Single Images</h2>
            <p>In this final phase, you'll see individual images containing two shadows.</p>
            <p><span class="highlight">Your task is to select which shadow looks brighter</span></p>
            <p>You'll evaluate ${images.length} images.</p>
            <p>Focus on the relative brightness of the two shadows within each image.</p>
          </div>`,
        choices: ['Start Phase 3'],
        on_load: function() {
          document.querySelector('.progress-container').style.display = 'none';
          document.getElementById('phase-indicator').style.display = 'none';
          document.getElementById('trial-counter').style.display = 'none';
        }
      });

      // Shuffle images for Phase 3
      const shuffledImages = jsPsych.randomization.shuffle(images);

      // Phase 3 trials
      shuffledImages.forEach((img, idx) => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="image-container">
              <img src="${img}" alt="Test image" />
            </div>
            <div class="question-text">Which shadow looks brighter?</div>
          `,
          choices: ['Left Shadow', 'Same Brightness', 'Right Shadow'],
          data: {
            phase: 'phase3',
            image: img.split('/').pop(),
            trial_index: idx + 1,
            total_trials: shuffledImages.length
          },
          on_start: function() {
            trialCounter++;
            updateProgressBar(trialCounter, totalTrials, "Shadow Intensity");
          },
          post_trial_gap: 300,
          on_finish: data => {
            const labels = ['left', 'same', 'right'];
            data.response = labels[data.response];
            data.chosen_shadow = data.response;
          }
        });
      });

      // Save data to Google Sheets - FIXED VERSION
      timeline.push({
        type: jsPsychCallFunction,
        async: true,
        func: async () => {
          // Get participant ID from earlier form
          const formData = jsPsych.data.get().filter({trial_type: 'survey-html-form'}).values()[0];
          participantID = formData.response.participant_id;
          
          // Get all trial data
          const trials = jsPsych.data.get()
            .filter(trial => trial.phase)
            .values()
            .map(trial => ({
              phase: trial.phase,
              image_left: trial.image_left || '',
              image_right: trial.image_right || '',
              chosen_image: trial.chosen_image || '',
              image: trial.image || '',
              response: trial.response,
              rt: trial.rt
            }));
          
          // Actually save the data
          saveResult = await saveToGoogleSheets(participantID, trials);
          
          // Return the result for data tracking
          return {
            saveResult: saveResult,
            participantID: participantID
          };
        },
        on_finish: (data) => {
          // Store the result in the trial data
          data.saveResult = saveResult;
          data.participantID = participantID;
        }
      });
      
      // Fixed Thank You Screen - Now working properly
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: function() {
          // Get the save result from global variables
          if (saveResult && participantID) {
            if (saveResult.success) {
              createConfetti();
              return `
                <div class="welcome-card">
                  <h2>‚úÖ Experiment Complete!</h2>
                  <p>Thank you for participating in our study!</p>
                  <p>Your responses have been successfully recorded for participant ID: <strong>${participantID}</strong></p>
                  
                  <div class="debrief-section">
                    <h3>About This Study</h3>
                    <p>This experiment investigates how humans perceive differences in shadow properties. Specifically, we're examining:</p>
                    <ul>
                      <li>How sensitive people are to differences in shadow brightness</li>
                      <li>Whether people perceive color differences in shadows under varying conditions</li>
                      <li>How context affects shadow perception in multi-shadow environments</li>
                    </ul>
                    
                    <h3>Why This Research Matters</h3>
                    <p>Understanding shadow perception helps us:</p>
                    <ul>
                      <li>Improve computer vision systems</li>
                      <li>Develop better visual displays and interfaces</li>
                      <li>Understand fundamental principles of human vision</li>
                      <li>Advance fields like computer graphics and augmented reality</li>
                    </ul>
                    
                    <h3>Your Contribution</h3>
                    <p>By participating, you've contributed valuable data that will help advance our understanding of visual perception. Your anonymous responses will be analyzed along with others to identify patterns in shadow perception.</p>
                  </div>
                  
                  <p>You may now close this window or click below to restart the experiment.</p>
                </div>`;
            } else {
              return `
                <div class="welcome-card">
                  <h2 class="error-message">‚ö†Ô∏è Data Save Error</h2>
                  <p>We encountered an issue saving your data: ${saveResult.message}</p>
                  <p>Please contact the researcher with your participant ID: <strong>${participantID}</strong></p>
                  <p>As a backup, we've stored your data in this browser. Please do not clear your browser data until you've contacted the researcher.</p>
                </div>`;
            }
          } else {
            return `
              <div class="welcome-card">
                <h2 class="error-message">‚ö†Ô∏è Data Processing Error</h2>
                <p>We encountered an issue processing your data. Please contact the researcher.</p>
                <p>If you have your participant ID, please record it: ${participantID || 'Not available'}</p>
              </div>`;
          }
        },
        choices: ['Restart Experiment', 'Exit'],
        on_finish: data => {
          if (data.response === 0) {
            location.reload();
          }
        }
      });

      return timeline;
    }

    function runExperiment() {
      jsPsych.run(createTimeline());
    }

    runExperiment();
  </script>
  
  <div class="footer">
    Perception Study | Department of Cognitive Psychology | ¬© 2023
  </div>
</body>
</html>
