<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shadow Color Perception Experiment</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />

  <style>
    /* --- Your CSS here unchanged --- */
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <script>
    // --- CONFIG ---
    const GITHUB_USERNAME = "kidat";
    const GITHUB_REPO = "shadow-experiment";
    const IMAGES_BRANCH = "main";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzsXyBmBpfYD8hm0MT_Y_AsNTqb4EcOZ6doxyUwZmNe2MrPnEll5eGXVmvTa0ipRs7_pQ/exec";

    const repoBase = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${IMAGES_BRANCH}/`;
    const images = Array.from({ length: 15 }, (_, i) => `${repoBase}images/${i + 1}.png`);

    const jsPsych = initJsPsych({ display_element: 'jspsych-target' });

    async function saveToGoogleSheets(participantID, trialsData) {
      const response = await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ participantID, trials: trialsData })
      });
      if (!response.ok) throw new Error("Google Sheets save failed");
      return response.json();
    }

    function createTimeline() {
      const timeline = [];

      timeline.push({ type: jsPsychPreload, images });

      // Welcome
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="card">
            <h1>Shadow Color Perception Experiment</h1>
            <p>Thank you for participating in this color perception study.</p>
            <p>This experiment has two phases:</p>
            <ol><li>Pairwise comparison of shadow intensity</li><li>Brightness difference detection</li></ol>
          </div>`,
        choices: ['Begin']
      });

      // ID & CAPTCHA
      timeline.push({
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="card"><h3>Participant ID</h3><p>Enter your 4-digit ID</p></div>',
        html: `
          <div class="form-group">
            <input name="participant_id" type="text" pattern="\\d{4}" maxlength="4" required 
                   placeholder="Enter 4-digit ID" autocomplete="off" />
          </div>
          <div style="margin: 15px 0; text-align: center;">
            <p>Are you human? What is 3 + 4?</p>
            <input name="captcha" type="number" required style="max-width: 100px;" />
          </div>`,
        button_label: 'Continue',
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });

      // Phase 1 Instruction
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="card">
            <h2>Phase 1: Pairwise Comparison</h2>
            <p>You will see two images side by side.</p>
            <p><strong>Choose the image with the more intense shadow.</strong></p>
            <p>You will complete ${Math.floor(images.length / 5) * 4} comparisons.</p>
          </div>`,
        choices: ['Start Comparing']
      });

      // Pairwise Trials
      const selectedPairs = [];
      for (let i = 0; i < images.length; i += 5) {
        const block = images.slice(i, i + 5);
        for (let j = 0; j < block.length - 1; j++) {
          selectedPairs.push([block[j], block[j + 1]]);
        }
      }

      selectedPairs.forEach((pair, index) => {
        const progress = ((index + 1) / selectedPairs.length * 100).toFixed(0);
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="card">
              <div style="display:flex; justify-content:center; gap:30px; flex-wrap:wrap;">
                <div><img src="${pair[0]}" /><p>Image A</p></div>
                <div><img src="${pair[1]}" /><p>Image B</p></div>
              </div>
              <p>Which shadow is more intense?</p>
            </div>
            <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>`,
          choices: ['Image A', 'Image B'],
          data: {
            phase: 'phase1',
            image_left: pair[0].split('/').pop(),
            image_right: pair[1].split('/').pop()
          },
          on_finish: (data) => {
            data.chosen_image = data.response === 0 ? data.image_left : data.image_right;
            jsPsych.getDisplayElement().innerHTML = '';
          }
        });
      });

      // Phase 2 Instruction
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="card">
            <h2>Phase 2: Brightness Comparison</h2>
            <p>You'll see images with two shadows.</p>
            <p><strong>Indicate if there's a brightness difference.</strong></p>
          </div>`,
        choices: ['Begin Phase 2']
      });

      // Brightness Trials
      images.forEach((img, index) => {
        const progress = (50 + ((index + 1) / images.length * 50)).toFixed(0);
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="card">
              <div style="display:flex; justify-content:center;"><img src="${img}" /></div>
              <p>Do you see a brightness difference?</p>
            </div>
            <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>`,
          choices: ['Yes', 'No'],
          data: { phase: 'phase2', image: img.split('/').pop() },
          on_finish: (data) => {
            data.chosen_image_phase2 = data.image;
            data.brightness_difference = data.response === 0 ? 'yes' : 'no';
            jsPsych.getDisplayElement().innerHTML = '';
          }
        });
      });

      // Final Screen + Save to Google Sheets
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: async () => {
          const formTrial = jsPsych.data.get().filter({ trial_type: 'survey-html-form' }).values()[0];
          if (!formTrial?.response?.participant_id || !/^\d{4}$/.test(formTrial.response.participant_id)) {
            return `<div class="card"><h2 class="error-message">Error</h2><p>Missing or invalid Participant ID</p></div>`;
          }
          if (parseInt(formTrial.response.captcha) !== 7) {
            return `<div class="card"><h2 class="error-message">Verification Failed</h2><p>Incorrect CAPTCHA</p></div>`;
          }

          const participantID = formTrial.response.participant_id;
          const trialsData = jsPsych.data.get().filter(trial => trial.phase).values().map(trial => ({
            phase: trial.phase,
            image_left: trial.image_left || '',
            image_right: trial.image_right || '',
            chosen_image: trial.chosen_image || '',
            image: trial.image || '',
            brightness_difference: trial.brightness_difference || '',
            response: trial.response,
            rt: trial.rt
          }));

          try {
            await saveToGoogleSheets(participantID, trialsData);
            return `<div class="card thank-you"><h2 style="color:var(--primary);">Thank You!</h2><p>Responses saved successfully.</p></div>`;
          } catch (e) {
            return `<div class="card"><h2 class="error-message">Error</h2><p>Failed to save data: ${e.message}</p></div>`;
          }
        },
        choices: ['Repeat Experiment', 'Exit'],
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });

      return timeline;
    }

    function runExperiment() {
      jsPsych.run(createTimeline()).then(() => {
        const lastTrialData = jsPsych.data.get().last(1).values()[0];
        if (lastTrialData.response === 0) {
          jsPsych.reset();
          runExperiment();
        }
      });
    }

    runExperiment();
  </script>
</body>
</html>
