<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shadow Color Perception Experiment</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; background:#808080; margin:0; display:flex;justify-content:center;padding-top:40px; }
    #jspsych-target { width:100%;max-width:900px;text-align:center;padding:0 10px; }
    .welcome-card { background:#f0f0f0;padding:40px 30px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.15);color:#333;max-width:600px;margin:0 auto; }
    .jspsych-btn { font-size:1.1rem!important;padding:12px 30px!important;border-radius:8px!important;background:#007acc!important;color:#fff!important;border:none!important;cursor:pointer!important;margin:0 15px!important; }
    .jspsych-btn:hover { background:#005fa3!important; }
    .error-message { color:#d32f2f;font-weight:bold; }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  <script>
    // CONFIG
    const GITHUB_USERNAME = "kidat",
          GITHUB_REPO     = "shadow-experiment",
          IMAGES_BRANCH   = "main",
          GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYYfej-4FG59R2Bah_LKwnIpTYmLA2DiBdEyIJInMTWM4TGL9ODcXr5eGBOueXsEcNYg/exec",
          repoBase = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${IMAGES_BRANCH}/`,
          images = Array.from({length:15}, (_,i) => `${repoBase}images/${i+1}.png`),
          jsPsych = initJsPsych({ display_element: 'jspsych-target' });

    // saveToGoogleSheets now treats opaque/no-cors as success
    async function saveToGoogleSheets(participantID, trialsData) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({participantID, trials: trialsData}),
          redirect: "follow",
          mode: "no-cors"
        });
        if (response.type === 'opaque' || response.ok) {
          return {success:true, message:"Data submitted successfully"};
        } else {
          throw new Error(`Server responded with status ${response.status}`);
        }
      } catch (e) {
        console.error("Save error:", e);
        return {success:false, message:e.message};
      }
    }

    function createTimeline() {
      const timeline = [];

      timeline.push({ type: jsPsychPreload, images });

      // Welcome
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h1>Shadow Color Perception Experiment</h1>
            <p>Thanks for participating.</p>
            <p>Click <strong>Begin</strong> when ready.</p>
          </div>`,
        choices: ['Begin']
      });

      // ID form
      timeline.push({
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="welcome-card"><h3>Participant ID</h3></div>',
        html: '<input name="participant_id" type="text" pattern="\\d{4}" maxlength="4" required placeholder="4-digit ID" />',
        button_label: 'Continue',
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });

      // Pairwise brightness trials (Phase 1)
      const pairs = [];
      for (let i=0; i<images.length; i+=5) {
        const block = images.slice(i,i+5);
        for (let j=0; j<block.length-1; j++) pairs.push([block[j], block[j+1]]);
      }
      pairs.forEach(pair => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `<div style="display:flex;justify-content:center;gap:30px">
                       <img src="${pair[0]}" /><img src="${pair[1]}" />
                     </div><p>Which shadow is brighter?</p>`,
          choices: ['Left','Same','Right'],
          data: {phase:'phase1', left:pair[0], right:pair[1]},
          on_finish: d => {
            const labels=['left','same','right'];
            d.response = labels[d.response];
            d.chosen = d.response==='left'?d.left:d.response==='right'?d.right:'same';
            jsPsych.getDisplayElement().innerHTML='';
          }
        });
      });

      // Phase 2: color difference
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="welcome-card"><h2>Phase 2</h2><p>Do shadows differ in color?</p></div>`,
        choices:['Start']
      });
      pairs.forEach(pair => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `<div style="display:flex;justify-content:center;gap:30px">
                       <img src="${pair[0]}" /><img src="${pair[1]}" />
                     </div><p>Color difference?</p>`,
          choices:['Yes','No'],
          data:{phase:'phase2'}
        });
      });

      // Phase 3: single image
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="welcome-card"><h2>Phase 3</h2><p>Pick brighter shadow.</p></div>`,
        choices:['Start']
      });
      images.forEach(img => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `<div><img src="${img}" /></div><p>Which shadow?</p>`,
          choices:['Left','Same','Right'],
          data:{phase:'phase3', image:img}
        });
      });

      // 1) Save-to-Google
      timeline.push({
        type: jsPsychCallFunction,
        async: true,
        func: async () => {
          const form = jsPsych.data.get().filter({trial_type:'survey-html-form'}).values()[0];
          const pid = form.response.participant_id;
          const trials = jsPsych.data.get().filter(t=>t.phase).values();
          const saveResult = await saveToGoogleSheets(pid, trials);
          jsPsych.data.addProperties({saveResult, participantID:pid});
        }
      });

      // 2) Final screen (reads last trialâ€™s props)
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: () => {
          const last = jsPsych.data.get().last(1).values()[0];
          if (!last.saveResult) {
            return `<div class="welcome-card"><h2 class="error-message">Error retrieving save result</h2></div>`;
          }
          if (last.saveResult.success) {
            return `<div class="welcome-card"><h2>Thank You!</h2><p>Data saved for participant ${last.participantID}.</p></div>`;
          } else {
            return `<div class="welcome-card"><h2 class="error-message">Save Error</h2><p>${last.saveResult.message}</p></div>`;
          }
        },
        choices:['Repeat','Exit'],
        on_finish: d=>{ if (d.response===0){ jsPsych.endExperiment('',true); runExperiment(); } }
      });

      return timeline;
    }

    function runExperiment() {
      jsPsych.run(createTimeline());
    }

    runExperiment();
  </script>
</body>
</html>
