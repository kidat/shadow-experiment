<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shadow Color Perception Experiment</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />

 <style>
  body {
    font-family: Arial, sans-serif;
    background-color: #808080;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 40px;
    min-height: 100vh;
  }
  #jspsych-target {
    width: 100%;
    max-width: 900px;
    text-align: center;
    overflow-x: auto;
    padding: 0 10px;
  }
  img {
    max-height: 450px;
    max-width: 50vw;
    height: auto;
    width: auto;
    object-fit: contain;
    border: 2px solid #333;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  .welcome-card {
    background: #f0f0f0;
    padding: 40px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    color: #333;
    max-width: 600px;
    margin: 0 auto;
  }
  .welcome-card h1 {
    font-size: 2.2rem;
    margin-bottom: 15px;
    color: #222;
  }
  .welcome-card p {
    font-size: 1.1rem;
    line-height: 1.5;
    margin-bottom: 20px;
  }
  .jspsych-btn {
    font-size: 1.1rem !important;
    padding: 12px 30px !important;
    border-radius: 8px !important;
    background-color: #007acc !important;
    color: white !important;
    border: none !important;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin: 0 15px !important;
  }
  .jspsych-btn:hover {
    background-color: #005fa3 !important;
  }
  .error-message {
    color: #d32f2f;
    font-weight: bold;
  }
  .success-message {
    color: #2e7d32;
    font-weight: bold;
  }
  .jspsych-html-button-response .jspsych-btn-group {
    display: flex;
    justify-content: center;
    gap: 30px;
  }
  .progress-container {
    width: 100%;
    max-width: 600px;
    margin: 20px auto;
    background: #e0e0e0;
    border-radius: 10px;
    height: 15px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: #4CAF50;
    border-radius: 10px;
    transition: width 0.3s ease;
  }
  .phase-indicator {
    font-weight: bold;
    margin: 10px 0;
    font-size: 1.2rem;
    color: #333;
  }
</style>

</head>
<body>
  <div id="jspsych-target"></div>

  <script>
    // --- CONFIG ---
    const GITHUB_USERNAME = "kidat";
    const GITHUB_REPO = "shadow-experiment";
    const IMAGES_BRANCH = "main";
    // Updated Google Apps Script URL for the fixed version
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_ctpNLWxP2XAZsRR1a0pIBQzTyEiAOtIsi3hjO3egMURrcimyecIptagt4iJLoOGukQ/exec";

    const repoBase = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${IMAGES_BRANCH}/`;
    const images = Array.from({ length: 15 }, (_, i) => `${repoBase}images/${i + 1}.png`);

    const jsPsych = initJsPsych({ 
      display_element: 'jspsych-target',
      on_finish: () => {
        // Clean up after experiment
        document.body.style.backgroundColor = "#f0f0f0";
      }
    });

    // Enhanced save function with better error handling
    async function saveToGoogleSheets(participantID, trialsData) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ participantID, trials: trialsData })
        });
        
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          const errorMsg = result.error || `Server responded with status ${response.status}`;
          throw new Error(errorMsg);
        }
        
        return result;
      } catch (e) {
        console.error("Save error:", e);
        throw new Error(`Failed to save data: ${e.message}`);
      }
    }

    function createTimeline() {
      const timeline = [];
      let totalTrials = 0;
      let trialCounter = 0;

      // Calculate total trials for progress bar
      const selectedPairs = [];
      for (let i = 0; i < images.length; i += 5) {
        const block = images.slice(i, i + 5);
        for (let j = 0; j < block.length - 1; j++) {
          selectedPairs.push([block[j], block[j + 1]]);
        }
      }
      totalTrials = selectedPairs.length * 2 + images.length + 5; // Phases + instructions

      // Add progress bar to all trials
      const addProgressBar = (trial) => {
        return {
          ...trial,
          stimulus: trial.stimulus + `
            <div class="phase-indicator">${trial.data?.phase?.toUpperCase().replace('_', ' ') || 'EXPERIMENT'}</div>
            <div class="progress-container">
              <div class="progress-bar" style="width: ${(trialCounter++ / totalTrials * 100).toFixed(0)}%"></div>
            </div>
          `
        };
      };

      timeline.push({ type: jsPsychPreload, images });

      // Welcome screen
      timeline.push(addProgressBar({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h1>Shadow Color Perception Experiment</h1>
            <p>Thank you for participating in this color perception study.</p>
            <p>This experiment has three phases:</p>
            <p><strong>Phase 1:</strong> Pairwise comparison of shadow brightness</p>
            <p><strong>Phase 2:</strong> Brightness difference detection</p>
            <p><strong>Phase 3:</strong> Shadow brightness comparison</p>
            <p>Click <strong>"Begin"</strong> when you are ready to start.</p>
          </div>`,
        choices: ['Begin'],
        data: { phase: 'welcome' }
      }));
      
      // ID collection
      timeline.push(addProgressBar({
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="welcome-card"><h3>Participant ID</h3><p>Enter your 4-digit ID</p></div>',
        html: `
          <div class="form-group">
            <input name="participant_id" type="text" pattern="\\d{4}" maxlength="4" required 
                   placeholder="Enter 4-digit ID" autocomplete="off" />
          </div>`,
        button_label: 'Continue',
        data: { phase: 'id_collection' },
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      }));

      // Phase 1 Instruction
      timeline.push(addProgressBar({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h2>Phase 1: Pairwise Comparison</h2>
            <p>You will see two images side by side.</p>
            <p><strong>Choose the image with the brighter shadow</strong></p>
            <p>You will complete ${selectedPairs.length} comparisons.</p>
          </div>`,
        choices: ['Start Comparing'],
        data: { phase: 'phase1_instructions' },
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      }));

      // Phase 1 trials
      selectedPairs.forEach(pair => {
        timeline.push(addProgressBar({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div style="display: flex; justify-content: center; gap: 50px; margin: 20px 0;">
              <img src="${pair[0]}" />
              <img src="${pair[1]}" />
            </div>
            <p>Which shadow appears brighter?</p>
          `,
          choices: ['Left Shadow', 'Same', 'Right Shadow'],
          data: {
            phase: 'phase1',
            image_left: pair[0].split('/').pop(),
            image_right: pair[1].split('/').pop()
          },
          post_trial_gap: 300,
          on_finish: data => {
            const labels = ['left', 'same', 'right'];
            data.response = labels[data.response];
            jsPsych.getDisplayElement().innerHTML = '';
          }
        }));
      });

      timeline.push(addProgressBar({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h2>Phase 2: Color Difference Judgment</h2>
            <p>You will now see the same pairs of images again.</p>
            <p><strong>Do you see a color difference between the shadows in each pair?</strong></p>
          </div>`,
        choices: ['Start Phase 2'],
        data: { phase: 'phase2_instructions' },
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      }));

      selectedPairs.forEach(pair => {
        timeline.push(addProgressBar({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div style="display: flex; justify-content: center; gap: 50px; margin: 20px 0;">
              <img src="${pair[0]}" />
              <img src="${pair[1]}" />
            </div>
            <p><strong>Do you see a color difference between the shadows of each pair?</strong></p>
          `,
          choices: ['Yes', 'No'],
          data: {
            phase: 'phase2',
            image_left: pair[0].split('/').pop(),
            image_right: pair[1].split('/').pop()
          },
          post_trial_gap: 300,
          on_finish: data => {
            data.response = data.response === 0 ? 'yes' : 'no';
            jsPsych.getDisplayElement().innerHTML = '';
          }
        }));
      });

      timeline.push(addProgressBar({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="welcome-card">
            <h2>Phase 3: Shadow Brightness Comparison</h2>
            <p>Now, please look at images containing two shadows created by spheres.</p>
            <p>Choose which shadow looks more intense or if they appear the same.</p>
          </div>`,
        choices: ['Begin Phase 3'],
        data: { phase: 'phase3_instructions' },
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      }));

      images.forEach(img => {
        timeline.push(addProgressBar({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div style="display: flex; justify-content: center; margin: 20px 0;">
              <img src="${img}" />
            </div>
            <p>Which shadow looks more intense?</p>
          `,
          choices: ['Left Shadow', 'Same', 'Right Shadow'],
          data: { phase: 'phase3', image: img.split('/').pop() },
          post_trial_gap: 300,
          on_finish: data => {
            const labels = ['left', 'same', 'right'];
            data.response = labels[data.response];
            jsPsych.getDisplayElement().innerHTML = '';
          }
        }));
      });

      // Final Screen + Save to Google Sheets
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: async () => {
          const formTrial = jsPsych.data.get().filter({ trial_type: 'survey-html-form' }).values()[0];
          if (!formTrial?.response?.participant_id || !/^\d{4}$/.test(formTrial.response.participant_id)) {
            return `<div class="welcome-card"><h2 class="error-message">Error</h2><p>Missing or invalid Participant ID</p></div>`;
          }

          const participantID = formTrial.response.participant_id;
          const trialsData = jsPsych.data.get().filter(trial => trial.phase).values().map(trial => ({
            phase: trial.phase,
            image_left: trial.image_left || '',
            image_right: trial.image_right || '',
            image: trial.image || '',
            response: trial.response,
            rt: trial.rt
          }));

          try {
            const saveResult = await saveToGoogleSheets(participantID, trialsData);
            return `
              <div class="welcome-card">
                <h2 class="success-message">Thank You!</h2>
                <p>Responses saved successfully for participant ${participantID}.</p>
                <p>${trialsData.length} records were saved.</p>
                <p>You may now close this window.</p>
              </div>
            `;
          } catch (e) {
            // Save data to local storage as backup
            localStorage.setItem(`shadowExpData_${participantID}`, JSON.stringify(trialsData));
            
            return `
              <div class="welcome-card">
                <h2 class="error-message">Data Save Error</h2>
                <p>${e.message}</p>
                <p>Your data has been saved locally as a backup.</p>
                <p>Please contact the researcher with your participant ID: ${participantID}</p>
              </div>
            `;
          }
        },
        choices: ['Exit'],
        data: { phase: 'completion' }
      }));

      return timeline;
    }

    function runExperiment() {
      jsPsych.run(createTimeline());
    }

    runExperiment();
  </script>
</body>
</html>
