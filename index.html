<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shadow Color Perception Experiment</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <script src="https://unpkg.com/@jspsych/plugin-call-function"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #808080;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 40px;
      min-height: 100vh;
    }
    #jspsych-target {
      width: 100%;
      max-width: 900px;
      text-align: center;
      overflow-x: auto;
      padding: 0 10px;
    }
    img {
      max-height: 450px;
      max-width: 50vw;
      height: auto;
      width: auto;
      object-fit: contain;
      border: 2px solid #808080;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .welcome-card {
      background: #f0f0f0;
      padding: 40px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      color: #333;
      max-width: 600px;
      margin: 0 auto;
    }
    .welcome-card h1 {
      font-size: 2.2rem;
      margin-bottom: 15px;
      color: #222;
    }
    .welcome-card p {
      font-size: 1.1rem;
      line-height: 1.5;
      margin-bottom: 20px;
    }
    .jspsych-btn {
      font-size: 1.1rem !important;
      padding: 12px 30px !important;
      border-radius: 8px !important;
      background-color: #007acc !important;
      color: white !important;
      border: none !important;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 0 15px !important;
    }
    .jspsych-btn:hover {
      background-color: #005fa3 !important;
    }
    .error-message {
      color: #d32f2f;
      font-weight: bold;
    }
    .success-message {
      color: #2e7d32;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>
  <script>
    const GITHUB_USERNAME = "kidat";
    const GITHUB_REPO = "shadow-experiment";
    const IMAGES_BRANCH = "main";
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNHv3H9Kn5oZdVvHF7oKDyYZL-SXv2uv9JbywaWKuPmag89NOhqoIhfn6s63gKssgrug/exec";

    const repoBase = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${IMAGES_BRANCH}/`;
    const images = Array.from({ length: 15 }, (_, i) => `${repoBase}images/${i + 1}.png`);
    const jsPsych = initJsPsych({ display_element: 'jspsych-target' });

    async function saveToGoogleSheets(participantID, trialsData) {
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ participantID, trials: trialsData })
        });
        return { success: true };
      } catch (e) {
        console.error("Save error:", e);
        return { success: false, message: e.message };
      }
    }

    function createTimeline() {
      const timeline = [];
      timeline.push({ type: jsPsychPreload, images });

      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="welcome-card"><h1>Shadow Color Perception Experiment</h1><p>Click "Begin" to start.</p></div>`,
        choices: ['Begin']
      });

      timeline.push({
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="welcome-card"><h3>Participant ID</h3><p>Enter your 4-digit ID</p></div>',
        html: `<input name="participant_id" type="text" pattern="\\d{4}" maxlength="4" required placeholder="Enter 4-digit ID" />`,
        button_label: 'Continue',
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });

      // Phase instructions
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="welcome-card"><h2>Phase 1</h2><p>Choose the brighter shadow.</p></div>`,
        choices: ['Start Comparing']
      });

      // Generate random image pairs
      const selectedPairs = [];
      for (let i = 0; i < images.length; i += 5) {
        const block = images.slice(i, i + 5);
        for (let j = 0; j < block.length - 1; j++) {
          const imageA = block[j];
          const imageB = block[j + 1];
          const flip = Math.random() < 0.5;
          selectedPairs.push({
            displayPair: flip ? [imageB, imageA] : [imageA, imageB],
            originalPair: [imageA, imageB],
            flipped: flip
          });
        }
      }

      // Phase 1 trials
      selectedPairs.forEach(pair => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div style="display:flex;justify-content:center;gap:50px;">
              <img src="${pair.displayPair[0]}" />
              <img src="${pair.displayPair[1]}" />
            </div>
            <p>Which image has the brighter shadow?</p>
          `,
          choices: ['Left Image', 'Same', 'Right Image'],
          data: {
            phase: 'phase1',
            image_left: pair.displayPair[0].split('/').pop(),
            image_right: pair.displayPair[1].split('/').pop(),
            original_first: pair.originalPair[0].split('/').pop(),
            original_second: pair.originalPair[1].split('/').pop(),
            flipped: pair.flipped
          },
          on_finish: data => {
            const labels = ['left', 'same', 'right'];
            data.response_display = labels[data.response];
            if (data.response === 1) data.response_ordered = 'same';
            else if (!data.flipped) data.response_ordered = data.response === 0 ? 'first' : 'second';
            else data.response_ordered = data.response === 0 ? 'second' : 'first';
          }
        });
      });

      // Phase 2 instructions
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="welcome-card"><h2>Phase 2</h2><p>Do the shadows appear different in color?</p></div>`,
        choices: ['Start Phase 2']
      });

      // Phase 2 trials (same pairs)
      selectedPairs.forEach(pair => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div style="display:flex;justify-content:center;gap:50px;">
              <img src="${pair.displayPair[0]}" />
              <img src="${pair.displayPair[1]}" />
            </div>
            <p>Do the shadows appear different in color?</p>
          `,
          choices: ['Yes', 'No'],
          data: {
            phase: 'phase2',
            image_left: pair.displayPair[0].split('/').pop(),
            image_right: pair.displayPair[1].split('/').pop(),
            original_first: pair.originalPair[0].split('/').pop(),
            original_second: pair.originalPair[1].split('/').pop(),
            flipped: pair.flipped
          },
          on_finish: data => {
            data.response_display = data.response === 0 ? 'yes' : 'no';
            data.response_ordered = data.response_display;
          }
        });
      });

      // Phase 3 instructions
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `<div class="welcome-card"><h2>Phase 3</h2><p>Select the brighter shadow on a single image.</p></div>`,
        choices: ['Begin Phase 3']
      });

      // Phase 3 single images
      images.forEach(img => {
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `<div style="display:flex;justify-content:center;"><img src="${img}" /></div><p>Which shadow looks brighter?</p>`,
          choices: ['Left Shadow', 'Same', 'Right Shadow'],
          data: {
            phase: 'phase3',
            image: img.split('/').pop()
          },
          on_finish: data => {
            const labels = ['left', 'same', 'right'];
            data.response_display = labels[data.response];
            data.response_ordered = labels[data.response];
          }
        });
      });

      // Save data to Google Sheets
      timeline.push({
        type: jsPsychCallFunction,
        func: () => {
          return new Promise(async (resolve) => {
            const formData = jsPsych.data.get().filter({ trial_type: 'survey-html-form' }).values()[0];
            const participantID = formData?.response?.participant_id ?? 'unknown';
            jsPsych.data.addProperties({ participantID });

            const trials = jsPsych.data.get()
              .filter(trial => trial.phase && ['phase1', 'phase2', 'phase3'].includes(trial.phase))
              .values()
              .map(trial => ({
                phase: trial.phase,
                image_first: trial.original_first ?? trial.image ?? '',
                image_second: trial.original_second ?? '',
                image_left_display: trial.image_left ?? '',
                image_right_display: trial.image_right ?? '',
                response_ordered: trial.response_ordered ?? '',
                response_display: trial.response_display ?? '',
                flipped: trial.flipped ?? '',
                rt: trial.rt ?? ''
              }));

            await saveToGoogleSheets(participantID, trials);
            resolve();
          });
        }
      });

      // Final screen
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: () => {
          const participantID = jsPsych.data.get().values().find(d => d.participantID)?.participantID ?? 'unknown';
          return `<div class="welcome-card"><h2>Thank You!</h2><p>Your data has been saved.</p><p>Your Participant ID: <strong>${participantID}</strong></p></div>`;
        },
        choices: ['Repeat Experiment', 'Exit'],
        on_finish: data => {
          if (data.response === 0) window.location.reload();
          else jsPsych.endExperiment('Experiment complete.');
        }
      });

      return timeline;
    }

    jsPsych.run(createTimeline());
  </script>
</body>
</html>
