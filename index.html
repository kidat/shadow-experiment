<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shadow Color Perception Experiment</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #2c5282;       --primary-light: #4299e1;
      --secondary: #718096;     --background: #f7fafc;
      --card-bg: #ffffff;       --success: #38a169;
      --warning: #e53e3e;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--background);
      margin: 0; padding: 30px 0;
      min-height: 100vh;
      display: flex; justify-content: center;
    }
    
    #jspsych-target {
      width: 100%; max-width: 700px;
      padding: 0 15px;
    }
    
    img {
      max-height: 320px; max-width: 40vw;
      border-radius: 8px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      background: #f0f0f0;
      border: 1px solid #ddd;
    }
    
    .card {
      background: var(--card-bg); padding: 25px;
      border-radius: 12px; margin: 0 auto 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.07);
      border: 1px solid rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .card h1, .card h2 { 
      color: var(--primary); 
      margin-top: 0;
      text-align: center;
    }
    
    .btn {
      font-size: 1rem !important; padding: 10px 22px !important;
      border-radius: 8px !important; background: var(--primary) !important;
      color: white !important; border: none !important; cursor: pointer;
      transition: all 0.2s; margin: 5px;
      font-weight: 600;
    }
    
    .btn:hover {
      background: var(--primary-light) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .progress {
      width: 100%; max-width: 400px; height: 10px;
      background: #e2e8f0; border-radius: 5px; margin: 20px auto;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%; background: var(--primary); 
      border-radius: 5px; transition: width 0.3s;
    }
    
    .form-group { margin: 15px 0; text-align: center; }
    .form-group input {
      padding: 10px 15px; border: 1px solid #cbd5e0;
      border-radius: 8px; width: 100%; max-width: 200px;
      margin: 10px auto; display: block;
      font-size: 1rem;
      text-align: center;
    }
    
    .thank-you {
      text-align: center;
      padding: 20px;
    }
    
    .error-message {
      color: var(--warning);
      font-weight: bold;
    }
    
    .debug-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 0.9rem;
      text-align: left;
    }
    
    .image-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    
    .image-pair {
      text-align: center;
    }
    
    .image-pair p {
      margin-top: 8px;
      font-weight: 500;
    }
    
    @media (max-width: 768px) {
      img { max-width: 75vw; }
      .card { padding: 20px; }
      .image-container { flex-direction: column; align-items: center; }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <script>
    // =====================================================================
    // CONFIGURATION
    // =====================================================================
    
    // GitHub repository information
    const GITHUB_USERNAME = "kidat";
    const GITHUB_REPO = "shadow-experiment";
    const IMAGES_BRANCH = "main";
    
    // Google Apps Script URL - FIXED with proper CORS handling
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzuher8mHoh5e1I3fMuP7uuTqP9s4zakWzvOoEt5pPqwUFf_lvbJRVZQWQk4wAg0pHm7Q/exec";
    
    // =====================================================================
    
    // Image paths for GitHub Pages
    const repoBase = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${IMAGES_BRANCH}/`;
    const images = Array.from({ length: 15 }, (_, i) => `${repoBase}images/${i + 1}.png`);
    
    // Log configuration for debugging
    console.log('Experiment Configuration:', {
      GITHUB_USERNAME,
      GITHUB_REPO,
      IMAGES_BRANCH,
      GOOGLE_SCRIPT_URL,
      images
    });

    const jsPsych = initJsPsych({ 
      display_element: 'jspsych-target',
      on_error: function(error) {
        console.error('jsPsych Error:', error);
        document.getElementById('jspsych-target').innerHTML = `
          <div class="card" style="border: 2px solid var(--warning);">
            <h2 class="error-message">Experiment Error</h2>
            <p>${error.message}</p>
            <p>Please try refreshing the page or contact the researcher.</p>
            <div class="debug-info">
              <strong>Error details:</strong><br>
              ${error.stack || 'No stack trace available'}
            </div>
          </div>
        `;
      }
    });

    // Save data to Google Sheets - FIXED with CORS mode
    async function saveToGoogleSheets(participantID, trialsData) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'cors', // Essential for cross-origin requests
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            participantID,
            trials: trialsData
          })
        });
        
        if (!response.ok) {
          throw new Error('Google Sheets save failed with status: ' + response.status);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Save error:', error);
        throw error;
      }
    }

    function createTimeline() {
      const timeline = [];
      
      // Preload images
      timeline.push({ 
        type: 'preload',
        images: images,
        on_error: function(error) {
          console.error('Image loading error:', error);
          // Continue even if some images fail to load
        },
        on_finish: function() {
          console.log('Images preloaded');
        }
      });
      
      // Welcome screen
      timeline.push({
        type: 'html-button-response',
        stimulus: `
          <div class="card">
            <h1>Shadow Perception Experiment</h1>
            <p>Thank you for participating in this study about how we perceive shadows.</p>
            <p>This experiment has two phases:</p>
            <ol>
              <li>Compare pairs of images to see which shadow appears more intense</li>
              <li>Look at individual images to detect brightness differences</li>
            </ol>
            <p>This study takes about 10 minutes to complete.</p>
          </div>
        `,
        choices: ['Begin Experiment'],
        on_load: function() {
          console.log('Welcome screen loaded');
        }
      });
      
      // Participant ID input
      timeline.push({
        type: 'survey-html-form',
        preamble: '<div class="card"><h3>Participant Information</h3><p>Please enter your participant ID</p></div>',
        html: `
          <div class="form-group">
            <input name="participant_id" type="text" pattern="\\d{4}" maxlength="4" required 
                   placeholder="Enter 4-digit ID" autocomplete="off" />
          </div>
          <div class="form-group">
            <p>Are you human? What is 3 + 4?</p>
            <input name="captcha" type="number" required style="max-width: 100px;" />
          </div>
        `,
        button_label: 'Continue',
        on_finish: function(data) {
          console.log('Participant ID entered:', data.response.participant_id);
          jsPsych.getDisplayElement().innerHTML = '';
        }
      });
      
      // Phase 1 instructions
      timeline.push({
        type: 'html-button-response',
        stimulus: `
          <div class="card">
            <h2>Phase 1: Pairwise Comparison</h2>
            <p>In this phase, you will see two images side by side.</p>
            <p><strong>Please choose the image where the shadow appears more intense.</strong></p>
            <p>You will complete ${Math.floor(images.length/5)*4} comparisons.</p>
          </div>
          <div class="progress"><div class="progress-bar" style="width: 10%"></div></div>
        `,
        choices: ['Start Comparing'],
        on_finish: function() {
          console.log('Phase 1 instructions complete');
          jsPsych.getDisplayElement().innerHTML = '';
        }
      });
      
      // Generate pairwise trials
      const selectedPairs = [];
      for (let i = 0; i < images.length; i += 5) {
        const block = images.slice(i, i + 5);
        for (let j = 0; j < block.length - 1; j++) {
          selectedPairs.push([block[j], block[j + 1]]);
        }
      }
      
      // Phase 1 trials
      selectedPairs.forEach((pair, index) => {
        const progress = ((index + 1) / selectedPairs.length * 100).toFixed(0);
        timeline.push({
          type: 'html-button-response',
          stimulus: `
            <div class="card">
              <div class="image-container">
                <div class="image-pair">
                  <img src="${pair[0]}" alt="Image A" onerror="this.style.display='none'; console.error('Image failed to load: ${pair[0]}')"/>
                  <p>Image A</p>
                </div>
                <div class="image-pair">
                  <img src="${pair[1]}" alt="Image B" onerror="this.style.display='none'; console.error('Image failed to load: ${pair[1]}')"/>
                  <p>Image B</p>
                </div>
              </div>
              <p>Which shadow is more intense?</p>
            </div>
            <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>
          `,
          choices: ['Image A', 'Image B'],
          data: { 
            phase: 'phase1', 
            image_left: pair[0].split('/').pop(), 
            image_right: pair[1].split('/').pop() 
          },
          post_trial_gap: 500,
          on_finish: function(data) {
            data.chosen_image = data.response === 0 ? pair[0].split('/').pop() : pair[1].split('/').pop();
            console.log(`Phase 1 trial ${index+1}: chose ${data.chosen_image}`);
            jsPsych.getDisplayElement().innerHTML = '';
          }
        });
      });
      
      // Phase 2 instructions
      timeline.push({
        type: 'html-button-response',
        stimulus: `
          <div class="card">
            <h2>Phase 2: Brightness Comparison</h2>
            <p>In this phase, you will see individual images containing two shadows.</p>
            <p><strong>Please indicate if you see a brightness difference between the shadows.</strong></p>
            <p>You will evaluate ${images.length} images.</p>
          </div>
          <div class="progress"><div class="progress-bar" style="width:50%"></div></div>
        `,
        choices: ['Begin Phase 2'],
        on_finish: function() {
          console.log('Phase 2 instructions complete');
          jsPsych.getDisplayElement().innerHTML = '';
        }
      });
      
      // Phase 2 trials
      images.forEach((img, index) => {
        const progress = (50 + ((index + 1) / images.length * 50)).toFixed(0);
        timeline.push({
          type: 'html-button-response',
          stimulus: `
            <div class="card">
              <div style="display:flex; justify-content:center; margin:15px 0;">
                <img src="${img}" alt="Shadow Comparison" onerror="this.style.display='none'; console.error('Image failed to load: ${img}')" />
              </div>
              <p>Do you see a brightness difference between the two shadows?</p>
            </div>
            <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>
          `,
          choices: ['Yes', 'No'],
          data: { phase: 'phase2', image: img.split('/').pop() },
          post_trial_gap: 500,
          on_finish: function(data) {
            data.chosen_image_phase2 = data.image;
            data.brightness_difference = data.response === 0 ? 'yes' : 'no';
            console.log(`Phase 2 trial ${index+1}: brightness difference = ${data.brightness_difference}`);
            jsPsych.getDisplayElement().innerHTML = '';
          }
        });
      });
      
      // Final trial with clear options
      timeline.push({
        type: 'html-button-response',
        stimulus: async function() {
          const formTrial = jsPsych.data.get().filter({ trial_type: 'survey-html-form' }).values()[0];
          
          // Validate participant ID and CAPTCHA
          if (!formTrial?.response?.participant_id || !/^\d{4}$/.test(formTrial.response.participant_id)) {
            return `
              <div class="card" style="border: 2px solid var(--warning);">
                <h2 class="error-message">Error: Invalid Participant ID</h2>
                <p>Your participant ID is invalid or missing.</p>
                <p>Please enter a valid 4-digit ID to save your data.</p>
              </div>
            `;
          }
          
          if (parseInt(formTrial.response.captcha) !== 7) {
            return `
              <div class="card" style="border: 2px solid var(--warning);">
                <h2 class="error-message">Verification Failed</h2>
                <p>Please answer the verification question correctly.</p>
                <p>The correct answer was 7.</p>
              </div>
            `;
          }
          
          const participantID = formTrial.response.participant_id;
          
          // Filter and prepare trial data
          const trialsData = jsPsych.data.get().filter(trial => 
            trial.phase && ['phase1', 'phase2'].includes(trial.phase)
          ).values().map(trial => ({
            phase: trial.phase,
            image_left: trial.image_left || '',
            image_right: trial.image_right || '',
            chosen_image: trial.chosen_image || '',
            image: trial.image || '',
            chosen_image_phase2: trial.chosen_image_phase2 || '',
            brightness_difference: trial.brightness_difference || '',
            response: trial.response,
            rt: trial.rt
          }));
          
          // Save to Google Sheets
          try {
            const saveResult = await saveToGoogleSheets(participantID, trialsData);
            console.log('Save result:', saveResult);
            
            return `
              <div class="card thank-you">
                <h2 style="color:var(--success);">Thank You!</h2>
                <p>Your responses have been successfully saved.</p>
                <p>We appreciate your participation in this study.</p>
                <p style="margin: 25px 0 15px; font-weight:500;">What would you like to do next?</p>
                <div class="debug-info">
                  <strong>Data saved for participant:</strong> ${participantID}<br>
                  <strong>Trials recorded:</strong> ${trialsData.length}
                </div>
              </div>
            `;
          } catch (error) {
            return `
              <div class="card" style="border: 2px solid var(--warning);">
                <h2 class="error-message">Data Save Error</h2>
                <p>Failed to save your data: ${error.message}</p>
                <p>Please contact the researcher with your Participant ID: ${participantID}</p>
                <div class="debug-info">
                  <strong>Error details:</strong> ${error.message}
                </div>
              </div>
            `;
          }
        },
        choices: ['Repeat Experiment', 'Exit'],
        on_finish: function() {
          jsPsych.getDisplayElement().innerHTML = '';
        }
      });
      
      return timeline;
    }
    
    // Run experiment
    function runExperiment() {
      jsPsych.run(createTimeline()).then(() => {
        const lastTrialData = jsPsych.data.get().last(1).values()[0];
        if (lastTrialData && lastTrialData.response === 0) {
          jsPsych.reset(); 
          runExperiment();
        }
      }).catch(error => {
        console.error('Experiment error:', error);
        document.getElementById('jspsych-target').innerHTML = `
          <div class="card" style="border: 2px solid var(--warning);">
            <h2 class="error-message">Experiment Failed to Start</h2>
            <p>${error.message}</p>
            <p>Please try refreshing the page or contact the researcher.</p>
            <div class="debug-info">
              <strong>Error details:</strong><br>
              ${error.stack || 'No stack trace available'}
            </div>
          </div>
        `;
      });
    }
    
    runExperiment();
  </script>
</body>
</html>
