<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shadow Color Perception Experiment</title>
  <script src="https://unpkg.com/jspsych@7.3.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form"></script>
  <script src="https://unpkg.com/@jspsych/plugin-preload"></script>
  <link href="https://unpkg.com/jspsych@7.3.0/css/jspsych.css" rel="stylesheet" />

  <style>
    :root {
      --primary: #2c5282;       --primary-light: #4299e1;
      --secondary: #718096;     --background: #f7fafc;
      --card-bg: #ffffff;       --success: #38a169;
      --warning: #e53e3e;
    }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--background);
      margin: 0; padding: 30px 0;
      min-height: 100vh;
      display: flex; justify-content: center;
    }
    
    #jspsych-target {
      width: 100%; max-width: 700px;
      padding: 0 15px;
    }
    
    img {
      max-height: 320px; max-width: 40vw;
      border-radius: 8px; 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .card {
      background: var(--card-bg); padding: 25px;
      border-radius: 12px; margin: 0 auto 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.07);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .card h1, .card h2 { 
      color: var(--primary); 
      margin-top: 0;
    }
    
    .btn {
      font-size: 1rem !important; padding: 10px 22px !important;
      border-radius: 8px !important; background: var(--primary) !important;
      color: white !important; border: none !important; cursor: pointer;
      transition: all 0.2s; margin: 5px;
    }
    
    .btn:hover {
      background: var(--primary-light) !important;
      transform: translateY(-2px);
    }
    
    .progress {
      width: 100%; max-width: 400px; height: 5px;
      background: #e2e8f0; border-radius: 3px; margin: 20px auto;
    }
    
    .progress-bar {
      height: 100%; background: var(--primary); 
      border-radius: 3px; transition: width 0.3s;
    }
    
    .form-group { margin: 15px 0; }
    .form-group input {
      padding: 8px 12px; border: 1px solid #cbd5e0;
      border-radius: 6px; width: 100%; max-width: 180px;
      margin: 5px auto; display: block;
    }
    
    .thank-you {
      text-align: center;
      padding: 20px;
    }
    
    .error-message {
      color: var(--warning);
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      img { max-width: 75vw; }
      .card { padding: 20px; }
    }
  </style>
</head>
<body>
  <div id="jspsych-target"></div>

  <script>
    // =====================================================================
    // CONFIGURATION: Set these values before deploying
    // =====================================================================
    
    // GitHub repository information (replace with your details)
    const GITHUB_USERNAME = "kidat";
    const GITHUB_REPO = "shadow-experiment";
    const IMAGES_BRANCH = "main"; // Branch where images are stored
    
    // Google Apps Script URL (from your deployment)
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzuher8mHoh5e1I3fMuP7uuTqP9s4zakWzvOoEt5pPqwUFf_lvbJRVZQWQk4wAg0pHm7Q/exec";
    
    // =====================================================================
    
    // Image paths for GitHub Pages
    const repoBase = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/${IMAGES_BRANCH}/`;
    const images = Array.from({ length: 15 }, (_, i) => `${repoBase}images/${i + 1}.png`);
    
    const jsPsych = initJsPsych({ display_element: 'jspsych-target' });

    // Save data to Google Sheets
    async function saveToGoogleSheets(participantID, trialsData) {
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            participantID,
            trials: trialsData
          })
        });
        
        if (!response.ok) {
          throw new Error('Google Sheets save failed');
        }
        
        return await response.json();
      } catch (error) {
        console.error('Save error:', error);
        throw error;
      }
    }

    function createTimeline() {
      const timeline = [];
      
      // Preload images
      timeline.push({ type: jsPsychPreload, images: images });
      
      // Welcome screen
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="card">
            <h1>Shadow Color Perception Experiment</h1>
            <p>Thank you for participating in this color perception study.</p>
            <p>This experiment has two phases:</p>
            <ol>
              <li>Pairwise comparison of shadow intensity</li>
              <li>Brightness difference detection</li>
            </ol>
          </div>
        `,
        choices: ['Begin']
      });
      
      // Participant ID input
      timeline.push({
        type: jsPsychSurveyHtmlForm,
        preamble: '<div class="card"><h3>Participant ID</h3><p>Enter your 4-digit ID</p></div>',
        html: `
          <div class="form-group">
            <input name="participant_id" type="text" pattern="\\d{4}" maxlength="4" required 
                   placeholder="Enter 4-digit ID" autocomplete="off" />
          </div>
          <div style="margin: 15px 0; text-align: center;">
            <p>Are you human? What is 3 + 4?</p>
            <input name="captcha" type="number" required style="max-width: 100px;" />
          </div>
        `,
        button_label: 'Continue',
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });
      
      // Phase 1 instructions
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="card">
            <h2>Phase 1: Pairwise Comparison</h2>
            <p>In this phase, you will see two images side by side.</p>
            <p><strong>Please choose the image with the more intense shadow.</strong></p>
            <p>You will complete ${Math.floor(images.length/5)*4} comparisons.</p>
          </div>
          <div class="progress"><div class="progress-bar" style="width: 10%"></div></div>
        `,
        choices: ['Start Comparing'],
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });
      
      // Generate pairwise trials
      const selectedPairs = [];
      for (let i = 0; i < images.length; i += 5) {
        const block = images.slice(i, i + 5);
        for (let j = 0; j < block.length - 1; j++) {
          selectedPairs.push([block[j], block[j + 1]]);
        }
      }
      
      // Phase 1 trials
      selectedPairs.forEach((pair, index) => {
        const progress = ((index + 1) / selectedPairs.length * 100).toFixed(0);
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="card">
              <div style="display:flex; justify-content:center; gap:30px; margin:15px 0; flex-wrap: wrap;">
                <div>
                  <img src="${pair[0]}" alt="Left Image" />
                  <p style="text-align: center; margin-top: 8px;">Image A</p>
                </div>
                <div>
                  <img src="${pair[1]}" alt="Right Image" />
                  <p style="text-align: center; margin-top: 8px;">Image B</p>
                </div>
              </div>
              <p>Which shadow is more intense?</p>
            </div>
            <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>
          `,
          choices: ['Image A', 'Image B'],
          data: { 
            phase: 'phase1', 
            image_left: pair[0].split('/').pop(), 
            image_right: pair[1].split('/').pop() 
          },
          post_trial_gap: 500,
          on_finish: (data) => {
            data.chosen_image = data.response === 0 ? pair[0].split('/').pop() : pair[1].split('/').pop();
            jsPsych.getDisplayElement().innerHTML = '';
          }
        });
      });
      
      // Phase 2 instructions
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: `
          <div class="card">
            <h2>Phase 2: Brightness Comparison</h2>
            <p>In this phase, you will see individual images containing two shadows.</p>
            <p><strong>Please indicate if you see a brightness difference between the shadows.</strong></p>
            <p>You will evaluate ${images.length} images.</p>
          </div>
          <div class="progress"><div class="progress-bar" style="width:50%"></div></div>
        `,
        choices: ['Begin Phase 2'],
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });
      
      // Phase 2 trials
      images.forEach((img, index) => {
        const progress = (50 + ((index + 1) / images.length * 50)).toFixed(0);
        timeline.push({
          type: jsPsychHtmlButtonResponse,
          stimulus: `
            <div class="card">
              <div style="display:flex; justify-content:center; margin:15px 0;">
                <img src="${img}" alt="Shadow Comparison" />
              </div>
              <p>Do you see a brightness difference between the two shadows?</p>
            </div>
            <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>
          `,
          choices: ['Yes', 'No'],
          data: { phase: 'phase2', image: img.split('/').pop() },
          post_trial_gap: 500,
          on_finish: (data) => {
            data.chosen_image_phase2 = data.image;
            data.brightness_difference = data.response === 0 ? 'yes' : 'no';
            jsPsych.getDisplayElement().innerHTML = '';
          }
        });
      });
      
      // Final trial with clear options
      timeline.push({
        type: jsPsychHtmlButtonResponse,
        stimulus: async () => {
          const formTrial = jsPsych.data.get().filter({ 
            trial_type: 'survey-html-form' 
          }).values()[0];
          
          // Validate participant ID and CAPTCHA
          if (!formTrial?.response?.participant_id || !/^\d{4}$/.test(formTrial.response.participant_id)) {
            return `
              <div class="card">
                <h2 class="error-message">Error</h2>
                <p>Invalid or missing Participant ID - data not saved</p>
              </div>
            `;
          }
          
          if (parseInt(formTrial.response.captcha) !== 7) {
            return `
              <div class="card">
                <h2 class="error-message">Verification Failed</h2>
                <p>Please answer the verification question correctly</p>
              </div>
            `;
          }
          
          const participantID = formTrial.response.participant_id;
          
          // Filter and prepare trial data
          const trialsData = jsPsych.data.get().filter(trial => 
            trial.phase && ['phase1', 'phase2'].includes(trial.phase)
          ).values().map(trial => ({
            phase: trial.phase,
            image_left: trial.image_left || '',
            image_right: trial.image_right || '',
            chosen_image: trial.chosen_image || '',
            image: trial.image || '',
            chosen_image_phase2: trial.chosen_image_phase2 || '',
            brightness_difference: trial.brightness_difference || '',
            response: trial.response,
            rt: trial.rt
          }));
          
          // Save to Google Sheets
          try {
            await saveToGoogleSheets(participantID, trialsData);
            
            return `
              <div class="card thank-you">
                <h2 style="color:var(--primary);">Thank You!</h2>
                <p>Your responses have been successfully saved.</p>
                <p>We appreciate your participation in this study.</p>
                <p style="margin: 25px 0 15px; font-weight:500;">What would you like to do next?</p>
              </div>
            `;
          } catch (error) {
            return `
              <div class="card">
                <h2 class="error-message">Error</h2>
                <p>Data save failed - please notify the researcher</p>
                <p>Error details: ${error.message}</p>
                <p>Your Participant ID: ${participantID}</p>
              </div>
            `;
          }
        },
        choices: ['Repeat Experiment', 'Exit'],
        on_finish: () => jsPsych.getDisplayElement().innerHTML = ''
      });
      
      return timeline;
    }
    
    // Run experiment
    function runExperiment() {
      jsPsych.run(createTimeline()).then(() => {
        const lastTrialData = jsPsych.data.get().last(1).values()[0];
        if (lastTrialData.response === 0) {
          jsPsych.reset(); 
          runExperiment();
        }
      });
    }
    
    runExperiment();
  </script>
</body>
</html>
